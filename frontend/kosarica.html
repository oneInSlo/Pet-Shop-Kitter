<!DOCTYPE html>

    <html lang="en">

        <head>

            <meta charset="UTF-8">
            <meta http-equiv="X-UA-Compatible" content="IE=edge">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <meta name="title" content="Kitter - High Quality Pet Food">
            <meta name="description" content="Welcome To Kitter!">

            <title>CART - Kitter: High Quality Pet Food</title>

            <link rel="icon" href="./assets/images/service-about-image.png">
            <link rel="stylesheet" href="./assets/css/style.css">
            <link rel="preconnect" href="https://fonts.googleapis.com">
            <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
            <link href="https://fonts.googleapis.com/css2?family=Bangers&family=Carter+One&family=Nunito+Sans:wght@400;700&display=swap" rel="stylesheet">
            
            <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
            <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
            <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
            <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>

        </head>

        <body onload="loadBackgroundColor()">

            <header class="header" id="header" data-header>

                <div class="container-fluid" data-nav-toggler>
                
                    <ul class="nav flex-column flex-sm-row">
                        <li class="nav-item flex-grow-1 d-flex align-items-center">
                            <a href="index.html" class="nav-link logo text-black">Kitter</a>
                        </li>
                        <li class="nav-item d-flex align-items-center">
                            <a href="index.html" class="nav-link text-black fs-3" data-nav-link>Home</a>
                          </li>
            
                          <li class="nav-item d-flex align-items-center">
                            <a href="about.html" class="nav-link text-black fs-3" data-nav-link>About Us</a>
                          </li>
            
                          <li class="nav-item d-flex align-items-center">
                            <a href="shop.html" class="nav-link text-black fs-3" data-nav-link>Shop</a>
                          </li>
            
                          <li class="nav-item d-flex align-items-center">
                            <a href="kosarica.html" class="nav-link text-black fs-3" data-nav-link>Cart</a>
                          </li>
            
                          <li class="nav-item d-flex align-items-center">
                            <a href="register.html" class="nav-link text-black fs-3" data-nav-link>Register</a>
                          </li>
            
                          <li class="nav-item d-flex align-items-center me-4">
                            <a href="settings.html" class="nav-link text-black fs-3" data-nav-link>Settings</a>
                          </li>
            
                          <li class="nav-item d-flex align-items-center">
                            <span id="formattedDate" class="nav-link bg-danger-subtle rounded text-black px-4 me-3 fs-3"></span>
                          </li>
            
                          <li class="nav-item d-flex align-items-center">
                            <button class="action-btn user" aria-label="User">
                                <span class="nav-link text-danger" data-toggle="modal" data-target="#loginModal">
                                  <ion-icon name="person-outline" aria-hidden="true"></ion-icon>
                                </span>
                            </button>
                          </li>
            
                    </ul>
            
                  </div>
            
            </header>

            <main>

                <div class="kosarica" id="box-cont">
                    
                    <h1>Your Cart</h1>

                    <div class="overflowing">
                        <table id="cartTable" class="table w-100 fs-4">
                        </table>
                    </div>
                </div>

                <div class="modal fade" id="loginModal">
                    <div class="modal-dialog modal-dialog-centered modal-lg">
                      <div class="modal-content">
                      
                        <div class="modal-header bg-danger">
                          <h2 class="modal-title fs-1 text-white">Login</h2>
                        </div>
                        
                        <div class="modal-body fs-3">
                          <form id="loginForm">
                            <div class="form-group">
                              <label for="username">Username:</label>
                              <input type="text" class="form-control fs-4 mt-2" id="username">
                            </div>
                            <div class="form-group">
                              <label for="password" class="mt-3">Password:</label>
                              <input type="password" class="form-control fs-4 mt-2" id="password">
                            </div>
                            <p class="mt-3">Don't have an account? <a href="register.html" class="d-inline text-decoration-none text-danger">Register</a>!</p>
                          </form>
                        </div>
                        
                        <div class="modal-footer">
                          <button type="button" class="btn btn-danger mt-2 fs-4 w-100" id="loginBtn">Login</button>
                          <button type="button" class="btn btn-secondary fs-4 w-100" data-dismiss="modal">Close</button>
                        </div>
                        
                      </div>
                    </div>
                  </div>

                <div class="kosarica time text-center" id="time">
                    <h1 class="fs-1 bg-danger-subtle py-3">Enjoy a generous 15% discount on every item available in our store!</h1>
                    <h1 class="countdown d-inline">
                        Time Left: <span class="span d-inline" id="countdown"></span>
                    </h1>
                </div>

                <div class="kosarica">
                    <h2>Have a Promotion Code?</h2>
                    <input type="text" id="promotion-input" class="w-100 py-1 fs-3 text-center">
                    <input type="button" value="Submit" class="btn btn-danger fs-3 w-100 mt-3" onclick="promotionCode()">
                </div>

                <div class="kosarica">
                    <h2>Choose Delivery Type</h2>
                    <select name="delivery" id="delivery" class="w-100 py-1 fs-3 text-center" onchange="deliverySelect()">
                        <option value="0.00" selected="selected" disabled="disabled">Please Choose...</option>
                        <option value="0.00">Personal Collection</option>
                        <option value="5.99">Standard Delivery</option>
                        <option value="8.99">Morning Delivery</option>
                        <option value="14.99">Express Shipment with Same Day Delivery</option>
                    </select>
                </div>

                
                <div class="kosarica">
                    <table class="table table-borderless">
                        <tbody>
                            <tr>
                                <td style="width: 90%;" class="text-end"><h2 id="originalPriceTitle" class="mb-0">Original Price:</h2></td>
                                <td style="width: 10%;" class="text-end fs-3"><span id="discount">€0.00</span></td>
                            </tr>
                            <tr>
                                <td class="text-end"><h2 id="discountPriceCode" class="mb-0">Promotion Code Discount:</h2></td>
                                <td class="text-end fs-3"><span id="codeDiscount">€0.00</span></td>
                            </tr>
                            <tr>
                                <td class="text-end"><h2 id="deliveryPriceTitle" class="mb-0">Delivery Price:</h2></td>
                                <td class="text-end fs-3"><span id="deliveryPrice">€0.00</span></td>
                            </tr>
                            <tr>
                                <td class="text-end"><h1 id="totalPriceTitle" class="mb-0 mt-5 text-danger">Total Price:</h1></td>
                                <td class="text-end fs-2"><h1 id="total" class="mt-5 text-danger">€0.00</h1></td>
                            </tr>
                        </tbody>
                    </table>
                </div>


                <div class="kosarica finalize">

                    <h1 class="text-center text-danger display-1 mb-5">Is that everything?</h1>
                    <button class="btn btn-danger w-100 fs-1 py-3" onclick="makePurchase(event)">Buy Products</button>
                    <h4 class="text-center mt-5">If you want to continue shopping, return to our <a href="shop.html" class="d-inline text-danger text-decoration-none">shop</a> and browse a variety of products!</h4>

                </div>
                

            </main>

            <script type="module" src="https://unpkg.com/ionicons@5.5.2/dist/ionicons/ionicons.esm.js"></script>
            <script nomodule src="https://unpkg.com/ionicons@5.5.2/dist/ionicons/ionicons.js"></script>

            <script src="./assets/js/script.js"></script>

            <script>
                window.addEventListener('load', () => {
                    displayCartItems();
                    displayTotal();
                    discount();
                    });
                
                let check = false;
                let finSum;

                function promotionCode() {
                    let promotion = document.getElementById("promotion-input").value;
                    if (promotion === "AKCIJA5") {
                        check = true;
                        alert('Congratulations!');
                        displayTotal();
                    }
                    else
                        alert('Wrong input. Please try again.');
                    }
                
                function deliverySelect() {
                    if (finSum - parseFloat(document.getElementById("deliveryPrice").textContent.slice(1)) > 50) {
                        document.getElementById("delivery").querySelectorAll('option').forEach(option => {
                            if (option.value === "5.99" || option.value === "8.99") {
                                option.value = "0.00";
                            }
                        });
                    } else {
                        document.getElementById("delivery").querySelectorAll('option').forEach(option => {
                            if (option.value === "0.00") {
                                if (option.index === 2) {
                                    option.value = "5.99";
                                } else if (option.index === 3) {
                                    option.value = "8.99";
                                }
                            }
                        });
                    }
                    displayTotal();
                    let delPrice = parseFloat(document.getElementById("delivery").value);
                    document.getElementById("deliveryPrice").textContent = "€" + delPrice.toFixed(2);
                }

                function displayTotal() {
                    let cartData = sessionStorage.getItem('cart');
                    const products = cartData.split(';');
                    const total = document.getElementById('total');

                    let sum = 0;
                    let max = 0;

                    for (const product of products) {
                        const productData = product.split(':');

                        if (productData.length >= 3) {
                            const price = parseFloat(productData[1] * productData[2]);
                            sum += price;
                        }

                        if (parseFloat(productData[1] * productData[2]) > max) {
                            max = parseFloat(productData[1] * productData[2]);
                        }
                    }

                    if (check) {
                        sum -= max * 0.05;
                        document.getElementById("codeDiscount").textContent = "€" + (max * 0.05).toFixed(2);  
                    }

                    sum += parseFloat(document.getElementById("delivery").value);
                    
                    finSum = sum;

                    if (!cartData) {
                        sum = 0.00; 
                        document.getElementById("discount").textContent = '€0.00';
                        document.getElementById("codeDiscount").textContent = '€0.00';
                        document.getElementById("deliveryPrice").textContent = '€0.00';
                    }

                    total.textContent = "€" + sum.toFixed(2);
                    }

                displayTotal();

                function discount() {
                    if (isOnSale(endDate)) {
                        let totalVal = (document.getElementById('total').textContent).slice(1);

                        let discount = document.getElementById("discount");
                    
                        discount.textContent = "€" + (parseFloat(totalVal) + parseFloat(totalVal) * 0.15).toFixed(2); 
                    
                    } else {
                        document.getElementById("originalPriceTitle").style.display = 'none';
                        document.getElementById("discount").style.display = 'none';
                    }
                
                }


                const makePurchase = (event) => {

                event.preventDefault();
                
                let basketData = {
                    userId: sessionStorage.getItem("userID"), 
                    products: sessionStorage.getItem("cart"),
                    totalAmount: document.getElementById("total").textContent,
                    dateOfPurchase: new Date().toISOString().split('T')[0] 
                };

                console.log(basketData);
               

                fetch("http://localhost:3000/purchase/", {
                    method: "POST",
                    body: JSON.stringify(basketData),
                    headers: {
                        "Content-Type": "application/json",
                    },
                })
                    .then((response) => {
                        if (!response.ok) {
                            throw new Error('Network response was not ok');
                        }
                        return response.json();
                    })
                    .then((data) => {
                        console.log(data);
                        alert('Thank you for shopping at Kitter! :)');
                    })
                    .catch((error) => {
                        console.error('Error making purchase:', error);
                        // Optionally, display an error message to the user
                    });
            };


            </script>

        </body>
    </html>
